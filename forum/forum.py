from flask import *
from flask_login import current_user
from flask_login.login_manager import LoginManager

from forum.model import *
from forum.user import *
from forum.utl import error, valid_title, valid_content


@app.route('/subforum')
def subforum():
    subforum_id = int(request.args.get("sub"))
    subforum = Subforum.query.filter(Subforum.id == subforum_id).first()
    if not subforum:
        return error("That subforum does not exist!")
    posts = Post.query.filter(Post.subforum_id == subforum_id).order_by(Post.id.desc()).limit(50)
    if not subforum.path:
        subforum.path = generateLinkPath(subforum.id)

    subforums = Subforum.query.filter(Subforum.parent_id == subforum_id).all()
    return render_template("subforum.html", subforum=subforum, posts=posts, subforums=subforums, path=subforum.path)

@app.route('/')
def index():
    subforums = Subforum.query.filter(Subforum.parent_id == None).order_by(Subforum.id)
    return render_template("subforums.html", subforums=subforums)


def add_subforum(title, description, parent=None):
    sub = Subforum(title, description)
    if parent:
        for subforum in parent.subforums:
            if subforum.title == title:
                return
        parent.subforums.append(sub)
    else:
        subforums = Subforum.query.filter(Subforum.parent_id == None).all()
        for subforum in subforums:
            if subforum.title == title:
                return
        db.session.add(sub)
    print("adding " + title)
    db.session.commit()
    return sub

# @login_required
# @app.route('/addpost')
# def addpost():
#     subforum_id = int(request.args.get("sub"))
#     subforum = Subforum.query.filter(Subforum.id == subforum_id).first()
#     if not subforum:
#         return error("That subforum does not exist!")
#
#     return render_template("createpost.html", subforum=subforum)
#
#
#
# @login_required
# @app.route('/action_post', methods=['POST'])
# def action_post():
#     subforum_id = int(request.args.get("sub"))
#     subforum = Subforum.query.filter(Subforum.id == subforum_id).first()
#     if not subforum:
#         return redirect(url_for("subforums"))
#
#     user = current_user
#     title = request.form['title']
#     content = request.form['content']
#     # check for valid posting
#     errors = []
#     retry = False
#     if not valid_title(title):
#         errors.append("Title must be between 4 and 140 characters long!")
#         retry = True
#     if not valid_content(content):
#         errors.append("Post must be between 10 and 5000 characters long!")
#         retry = True
#     if retry:
#         return render_template("createpost.html", subforum=subforum, errors=errors)
#     post = Post(title, content, datetime.datetime.now())
#     subforum.posts.append(post)
#     user.posts.append(post)
#     db.session.commit()
#     return redirect("/viewpost?post=" + str(post.id))
#
#
#
# @app.route('/viewpost')
# def viewpost():
#     postid = int(request.args.get("post"))
#     post = Post.query.filter(Post.id == postid).first()
#     if not post:
#         return error("That post does not exist!")
#     if not post.subforum.path:
#         subforumpath = generateLinkPath(post.subforum.id)
#     comments = Comment.query.filter(Comment.post_id == postid).order_by(
#         Comment.id.desc())  # no need for scalability now
#     return render_template("viewpost.html", post=post, path=subforumpath, comments=comments)



@login_required
@app.route('/addpost')
def addpost():
    subforum_id = int(request.args.get("sub"))
    subforum = Subforum.query.filter(Subforum.id == subforum_id).first()
    if not subforum:
        return error("That subforum does not exist!")

    return render_template("createpost.html", subforum=subforum)


@app.route('/viewpost')
def viewpost():
    postid = int(request.args.get("post"))
    post = Post.query.filter(Post.id == postid).first()
    if not post:
        return error("That post does not exist!")
    if not post.subforum.path:
        subforumpath = generateLinkPath(post.subforum.id)
    comments = Comment.query.filter(Comment.post_id == postid).order_by(
        Comment.id.desc())  # no need for scalability now
    return render_template("viewpost.html", post=post, path=subforumpath, comments=comments)


@login_required
@app.route('/action_post', methods=['POST'])
def action_post():
    subforum_id = int(request.args.get("sub"))
    subforum = Subforum.query.filter(Subforum.id == subforum_id).first()
    if not subforum:
        return redirect(url_for("subforums"))

    user = current_user
    title = request.form['title']
    content = request.form['content']
    # check for valid posting
    errors = []
    retry = False
    if not valid_title(title):
        errors.append("Title must be between 4 and 140 characters long!")
        retry = True
    if not valid_content(content):
        errors.append("Post must be between 10 and 5000 characters long!")
        retry = True
    if retry:
        return render_template("createpost.html", subforum=subforum, errors=errors)
    post = Post(title, content, datetime.datetime.now())
    subforum.posts.append(post)
    user.posts.append(post)
    db.session.commit()
    return redirect("/viewpost?post=" + str(post.id))

@login_required
@app.route('/action_comment', methods=['POST', 'GET'])
def comment():

    post_id = int(request.args.get("post"))
    post = Post.query.filter(Post.id == post_id).first()
    if not post:
        return error("That post does not exist!")
    content = request.form['content']
    postdate = datetime.datetime.now()
    comment = Comment(content, postdate)
    current_user.comments.append(comment)
    post.comments.append(comment)
    db.session.commit()
    return redirect("/viewpost?post=" + str(post_id))
def init_site():
    admin = add_subforum("Forum", "Announcements, bug reports, and general discussion about the forum belongs here")
    add_subforum("Announcements", "View forum announcements here",admin)
    add_subforum("Bug Reports", "Report bugs with the forum here", admin)
    add_subforum("General Discussion", "Use this subforum to post anything you want")
    add_subforum("Other", "Discuss other things here")

# # db.drop_all()
# db.create_all()
# if not Subforum.query.all():
#     init_site()

if __name__ == "__main__":
    # login_manager = LoginManager()
    # login_manager.init_app(app)
    db.create_all()
    if not Subforum.query.all():
        subforum.init_site()


# 	#runsetup()
# 	port = int(os.environ["PORT"])
# 	app.run(host='0.0.0.0', port=port, debug=True)

